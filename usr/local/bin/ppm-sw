#!/usr/bin/env bash

# Logger
lpm_logger () {
    logger -t legion-power-management -s "$1"
}

# Governors

set_governor_performance () {
    for GOVERNOR in $(ls /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor); do
        echo "performance" > ${GOVERNOR}
    done
}

set_governor_powersave () {
    for GOVERNOR in $(ls /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor); do
        echo "powersave" > ${GOVERNOR}
    done
}

# Energy Performance

set_epp_performance () {
    for GOVERNOR in $(ls /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference); do
        echo "performance" > ${GOVERNOR}
    done
}

set_epp_power () {
    for GOVERNOR in $(ls /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference); do
        echo "power" > ${GOVERNOR}
    done
}

# Profiles

set_profile_performance () {
    echo "perf"		> /proc/acpi/legion_call || lpm_logger "Error setting HW power profile!"
    echo "1"		> /sys/devices/system/cpu/intel_pstate/hwp_dynamic_boost
    set_governor_performance
    set_epp_performance
}

set_profile_balanced () {
    echo "balanced"	> /proc/acpi/legion_call || lpm_logger "Error setting HW power profile!"
    echo "1"		> /sys/devices/system/cpu/intel_pstate/hwp_dynamic_boost
    set_governor_performance
    set_epp_performance
}

set_profile_power-saver () {
    echo "quiet"	> /proc/acpi/legion_call || lpm_logger "Error setting HW power profile!"
    echo "0"		> /sys/devices/system/cpu/intel_pstate/hwp_dynamic_boost
    set_governor_powersave
    set_epp_power
}

# Monitor

dbus-monitor --system "type='signal',path='/net/hadess/PowerProfiles',member='PropertiesChanged'" | while read LINE; do
    POWER_PROFILE_SW=$(echo ${LINE} | grep 'variant' | sed -e 's/variant//g' -e 's/string//g' -e 's/\ //g' -e 's/"//g')
    if [[ -n "${POWER_PROFILE_SW}" ]]; then
        case ${POWER_PROFILE_SW} in
            performance)
                set_profile_performance
                ;;
            balanced)
                set_profile_balanced
                ;;
            power-saver)
                set_profile_power-saver
                ;;
            *)
                echo ${POWER_PROFILE_SW}
                ;;
        esac
    fi
done
