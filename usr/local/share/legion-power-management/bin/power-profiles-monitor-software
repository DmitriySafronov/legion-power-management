#!/usr/bin/env bash

# Logger
lpm_logger () {
    logger -t legion-power-management -s "$1"
}

# Governor
set_power_target () {
    case $1 in
        performance|balanced|power-saver)
            systemctl ${SYSTEMD_USER} start power-profile-$1.target
            ;;
        *)
            lpm_logger "Error in [power target] configuration!"
            ;;
    esac
}

# HW Power profile
set_hwpp () {
    if [ $EUID -eq 0 ] && [ -f /proc/acpi/legion_call ]; then
        case $1 in
            perf|balanced|quiet)
                echo "$1" > /proc/acpi/legion_call || lpm_logger "Error setting HW power profile!"
                ;;
            *)
                lpm_logger "Error in [HW power profile] configuration!"
                ;;
        esac
    fi
}

#######################################################
## Profiles

set_profile_performance () {
    set_hwpp perf
    set_power_target performance
}

set_profile_balanced () {
    set_hwpp balanced
    set_power_target balanced
}

set_profile_power-saver () {
    set_hwpp quiet
    set_power_target power-saver
}

#######################################################

unset SYSTEMD_USER
if [[ $EUID -ne 0 ]]; then
   SYSTEMD_USER="--user"
fi

#######################################################

# Monitor
dbus-monitor --system "type='signal',path='/net/hadess/PowerProfiles',member='PropertiesChanged'" | while read LINE; do
    POWER_PROFILE_SW=$(echo ${LINE} | grep 'variant' | sed -e 's/variant//g' -e 's/string//g' -e 's/\ //g' -e 's/"//g')
    if [[ -n "${POWER_PROFILE_SW}" ]]; then
        case ${POWER_PROFILE_SW} in
            performance)
                set_profile_performance
                ;;
            balanced)
                set_profile_balanced
                ;;
            power-saver)
                set_profile_power-saver
                ;;
            *)
                lpm_logger "Error getting SW power profile: [${POWER_PROFILE_SW}]!"
                ;;
        esac
    fi
done
